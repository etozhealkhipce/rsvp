name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  NAMESPACE: sskd
  BASE_REPO: etozhealkhipce/senior-script-kiddie-k3s

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: BUILD
        id: build
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.repository_owner }} --password-stdin

          TAG="sha-${GITHUB_SHA::7}"
          IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"

          docker build -t ${IMAGE}:${TAG} -t ${IMAGE}:latest .
          docker push ${IMAGE}:${TAG}
          docker push ${IMAGE}:latest

          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: SECRETS
        id: secrets
        run: |
          IFS=',' read -ra SECRET_NAMES <<< "DATABASE_URL,PGHOST,PGPORT,PGDATABASE,PGUSER,PGPASSWORD,SESSION_SECRET,RESEND_API_KEY,RESEND_FROM_EMAIL"

          cat > /tmp/secrets.json << 'SECRETS_EOF'
          ${{ toJSON(secrets) }}
          SECRETS_EOF

          SECRET_DATA=""
          for secret_name in "${SECRET_NAMES[@]}"; do
            secret_name=$(echo "$secret_name" | xargs)
            value=$(jq -r --arg k "$secret_name" '.[$k]' /tmp/secrets.json)
            
            if [ -n "$value" ] && [ "$value" != "null" ]; then
              encoded=$(echo -n "$value" | base64 -w 0)
              SECRET_DATA="${SECRET_DATA}  ${secret_name}: ${encoded}\n"
            fi
          done

          rm -f /tmp/secrets.json
          echo "data=$(echo -e "$SECRET_DATA" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: DEPLOY
        uses: appleboy/ssh-action@v1.0.3
        env:
          TAG: ${{ steps.build.outputs.tag }}
          REPO: ${{ github.repository }}
          OWNER: ${{ github.repository_owner }}
          SECRET_DATA: ${{ steps.secrets.outputs.data }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: TAG,REPO,OWNER,SECRET_DATA
          script: |
            set -e
            export KUBECONFIG=~/.kube/config

            echo "DEPLOYING MICROSERVICES..."

            # Создать app secrets
            if [ -n "$SECRET_DATA" ]; then
              # App secrets
              cat << EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: rsvp-app-secrets
              namespace: ${{ env.NAMESPACE }}
            type: Opaque
            data:
            $(echo "$SECRET_DATA" | base64 -d)
            EOF
              echo "SECRETS CREATED FOR rsvp-app"

              # Database secrets - нужны POSTGRES_* переменные
              PGUSER=$(echo "$SECRET_DATA" | base64 -d | grep "PGUSER:" | awk '{print $2}')
              PGDATABASE=$(echo "$SECRET_DATA" | base64 -d | grep "PGDATABASE:" | awk '{print $2}')
              PGPASSWORD=$(echo "$SECRET_DATA" | base64 -d | grep "PGPASSWORD:" | awk '{print $2}')

              cat << EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: rsvp-db-secrets
              namespace: ${{ env.NAMESPACE }}
            type: Opaque
            data:
              POSTGRES_USER: ${PGUSER}
              POSTGRES_DB: ${PGDATABASE}
              POSTGRES_PASSWORD: ${PGPASSWORD}
            EOF
              echo "SECRETS CREATED FOR rsvp-db"
            fi

            # секрет создаем
            kubectl create secret docker-registry rsvp-ghcr-secret \
              --docker-server=${{ env.REGISTRY }} \
              --docker-username=${OWNER} \
              --docker-password=${{ secrets.GHCR_TOKEN }} \
              -n ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

            cd /tmp && rm -rf deploy-rsvp
            mkdir deploy-rsvp && cd deploy-rsvp

            git clone --depth 1 https://github.com/${{ env.BASE_REPO }}.git base
            git clone --depth 1 https://github.com/${REPO}.git consumer

            cd base/charts/sskd-app
            helm dependency update

            echo "1/2 DEPLOYING DATABASE..."
            helm upgrade --install rsvp-db . \
              --namespace ${{ env.NAMESPACE }} \
              -f /tmp/deploy-rsvp/consumer/deploy/values-database.yml \
              --wait --timeout 5m

            echo "WAITING FOR DATABASE TO BE READY..."
            kubectl wait --for=condition=ready pod -l app=rsvp-db -n ${{ env.NAMESPACE }} --timeout=300s

            echo "2/2 DEPLOYING APP (Backend + Frontend)..."
            helm upgrade --install rsvp-app . \
              --namespace ${{ env.NAMESPACE }} \
              -f /tmp/deploy-rsvp/consumer/deploy/values.yml \
              --set app.image.tag=${TAG} \
              --wait --timeout 5m

            echo "COMPLETE!"
            kubectl get pods -n ${{ env.NAMESPACE }} -l 'app in (rsvp-app,rsvp-db)'

            rm -rf /tmp/deploy-rsvp
