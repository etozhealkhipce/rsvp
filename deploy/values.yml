app:
  name: rsvp-app
  namespace: sskd
  replicas: 1
  port: 5000
  healthPath: /api/health

  image:
    repository: ghcr.io/etozhealkhipce/rsvp
    tag: latest
    pullPolicy: Always

  imagePullSecrets:
    - name: rsvp-ghcr-secret

  initContainers:
    - name: migrate
      image: ghcr.io/etozhealkhipce/rsvp:latest
      command: ["sh", "-c"]
      args:
        - |
          apk add --no-cache postgresql-client
          echo "WAITING FOR DATABASE..."
          until pg_isready -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" 2>/dev/null; do
            echo "DATABASE UNAVAILABLE - SLEEPING"
            sleep 2
          done
          echo "RUNNING MIGRATIONS..."
          npx drizzle-kit push
          echo "MIGRATIONS COMPLETE"

  env:
    NODE_ENV: production
    PORT: "5000"
  envFrom:
    - secretRef:
        name: rsvp-app-secrets

  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  ingress:
    enabled: true
    host: rsvp.sskd.tech